<%= render "shared/payment_pointer", user: @autopost.user %>

<style>
  .html-variant-wrapper { display: none}
</style>

<%= render "shared/webcomponents_loader_script" %>
<% if user_signed_in? %>
  <%= javascript_packs_with_chunks_tag "clipboardCopy", "webShare", "articlePage", "articleModerationTools", "commentDropdowns", defer: true %>
<% else %>
  <%= javascript_packs_with_chunks_tag "clipboardCopy", "webShare", "articlePage", "commentDropdowns", defer: true %>
<% end %>

<div class="crayons-layout crayons-layout--3-cols crayons-layout--article">
  <aside class="crayons-layout__sidebar-left" aria-label="Article actions">
    <%= render "autoposts/actions" %>
  </aside>

  <main id="main-content" class="crayons-layout__content grid gap-4">
    <div class="article-wrapper">
      <% if !@autopost.published %>
        <div class="crayons-notice crayons-notice--danger mb-4" aria-live="polite">
          <strong>Unpublished Post.</strong> This URL is public but secret, so share at your own discretion.
          <% if user_signed_in? %>
            <a id="author-click-to-edit" href="<%= @autopost.path %>/edit" class="fw-bold" display="none">Click to edit</a>
          <% end %>
        </div>
      <% end %>

      <% if @autopost.video_state == "PROGRESSING" %>
        <div class="crayons-notice crayons-notice--warning mb-4" aria-live="polite">⏳ Video Transcoding In Progress ⏳</div>
      <% end %>

      <article class="crayons-card crayons-article mb-4"
        id="article-show-container"
        data-article-id="<%= @autopost.id %>"
        data-author-id="<%= @autopost.user_id %>"
        data-path="<%= @autopost.path %>"
        data-published="<%= @autopost.published? %>"
        data-pin-path="<%= stories_feed_pinned_article_path %>"
        data-pinned-article-id="<%= @pinned_article_id %>"
        <%= @autopost.pinned? ? "data-pinned" : " " %>>
        <header class="crayons-article__header" id="main-title">
          <% if @autopost.video.present? %>
            <%= render "autoposts/video_player", meta_tags: true, autopost: @autopost %>
          <% elsif @autopost.main_image.present? %>
            <div class="crayons-article__cover">
              <img src="<%= cloud_cover_url(@autopost.main_image) %>" width="1000" height="420" style="background-color:<%= @autopost.main_image_background_hex_color %>;" class="crayons-article__cover__image" alt="Cover image for <%= @autopost.title %>">
            </div>
          <% end %>

          <div class="crayons-article__header__meta">
            <% if @organization %>
              <a href="<%= @organization.path %>" class="flex items-center mb-4 fs-l fw-medium crayons-link">
                <span class="crayons-logo crayons-logo--l mr-3">
                  <img src="<%= Images::Profile.call(@organization.profile_image_url, length: 50) %>" class="crayons-logo__image" alt="<%= @organization.name %> profile image">
                </span>
                <%= @organization.name %>
              </a>
            <% end %>
            <h1 class="fs-3xl m:fs-4xl l:fs-5xl fw-bold s:fw-heavy lh-tight mb-4 <%= @autopost.title_length_classification %>">
              <% if @autopost.search_optimized_title_preamble.present? && !user_signed_in? %>
                <span class="fs-xl color-base-70 block"><%= @autopost.search_optimized_title_preamble %></span>
              <% end %>
              <%= @autopost.title %>
            </h1>

            <% cache("main-article-tags-#{@autopost.cached_tag_list}", expires_in: 30.hours) do %>
              <div class="mb-4 spec__tags">
                <% @autopost.cached_tag_list_array.each do |tag| %>
                  <% tag_hash = tag_colors(tag) %>
                  <% styles = "" %>
                  <% if tag_hash[:background] %>
                    <% styles = "background-color:#{tag_hash[:background]};" %>
                  <% end %>
                  <% if tag_hash[:color] %>
                    <% styles = "#{styles}color:#{tag_hash[:color]};" %>
                  <% end %>
                  <a class="crayons-tag mr-1" href="/t/<%= tag %>" style="<%= styles %>"><span class="crayons-tag__prefix">#</span><%= tag %></a>
                <% end %>
              </div>
            <% end %>

            <div class="crayons-article__subheader">
              <a href="/<%= @user.username %>" class="flex items-center mr-2 m:mr-1 mb-4 s:mb-0 fw-medium crayons-link">
                <span class="crayons-avatar crayons-avatar--l mr-2 m:mr-1"><img class="crayons-avatar__image" src="<%= Images::Profile.call(@user.profile_image_url, length: 50) %>" alt="" /></span>
                <span class="block m:hidden"><%= @user.name %></span>
              </a>
              <div class="profile-preview-card relative mr-2 mb-4 s:mb-0 fw-medium">
                <button id="profile-preview-trigger" class="profile-preview-card__trigger crayons-btn crayons-btn--ghost px-2 hidden m:block" aria-label="<%= @user.name %> profile details"><%= @user.name %></button>
                <%= render "/shared/profile_preview_card", actor: @user, id: "profile-preview-content" %>
              </div>

              <span class="fs-s mb-4 s:mb-0">
                <% if @autopost.published_timestamp.present? %>
                  <%= local_date(@autopost.published_timestamp, show_year: @autopost.displayable_published_at.year != Time.current.year) %>
                <% end %>
                <% if @autopost.co_author_ids.present? %>
                  <em>with <%= @autopost.co_author_name_and_path.html_safe %></em>
                <% end %>

                <% if should_show_crossposted_on?(@autopost) %>
                  <em>
                    Originally published at
                    <a href="<%= @autopost.canonical_url || @autopost.feed_source_url %>" style="color:#1395b8"><%= get_host_without_www(@autopost.canonical_url || @autopost.feed_source_url) %></a>
                    <% if @autopost.crossposted_at %>
                      on
                      <%= local_date(@autopost.originally_published_at || @autopost.published_at, show_year: (@autopost.originally_published_at || @autopost.published_at).year != Time.current.year) %>
                    <% end %>
                  </em>
                <% end %>
                <% if should_show_updated_on?(@autopost) %>
                  ・<em>Updated on <%= local_date(@autopost.edited_at, show_year: @autopost.edited_at.year != Time.current.year) %></em>
                <% end %>

                <span class="mr-4">・<%= @autopost.reading_time < 1 ? 1 : @autopost.reading_time %> min read</span>
              </span>
              <span id="action-space" class="mb-4 s:mb-0"></span>
            </div>
          </div>
        </header>

        <div class="crayons-article__main">
          <% if @collection %>
            <%= render "autoposts/collection",
                       rendered_autopost: @autopost,
                       collection: @collection,
                       articles: @collection_articles %>
          <% end %>

          <div class="crayons-article__body text-styles spec__body" data-article-id="<%= @autopost.id %>" id="article-body">
            <%= @autopost.processed_html.html_safe %>
          </div>

          <% if @autopost.long_markdown? && @collection %>
            <%= render "autoposts/collection",
                       rendered_autopost: @autopost,
                       collection: @collection,
                       articles: @collection_articles %>
          <% end %>
        </div>
        <%= render "autoposts/full_comment_area" %>

      </article>

      <% cache("article-bottom-content-#{@autopost.id}-#{user_signed_in?}-#{(@organization || @user).latest_article_updated_at}", expires_in: 18.hours) do %>
        <% suggested_articles = Articles::Suggest.call(@autopost, max: 4) %>
        <%= render "autoposts/bottom_content", articles: suggested_articles %>
      <% end %>
    </div>
  </main>

  <aside class="crayons-layout__sidebar-right" aria-label="Author details">
    <% stick_nav_cache_key = "sticky-sidebar-#{@autopost.id}-#{(@organization || @user).profile_updated_at}-#{(@organization || @user).latest_article_updated_at}" %>
    <% cache(stick_nav_cache_key, expires_in: 50.hours) do %>
      <%= render "autoposts/sticky_nav" %>
    <% end %>
  </aside>
</div>

<% cache("specific-article-extra-scripts-#{@autopost.id}-#{@autopost.updated_at}", expires_in: 24.hours) do %>
  <% if has_vid?(@autopost) %>
    <%= render "autoposts/fitvids" %>
  <% end %>
  <% if @autopost.processed_html.include?('class="twitter-tweet"') ||
       @autopost.processed_html.include?("ltag_twitter_timeline-liquid-tag") %>
    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  <% end %>
  <% if @autopost.processed_html.include? "instagram-media" %>
    <script async defer src="//platform.instagram.com/en_US/embeds.js"></script>
  <% end %>
<% end %>

<div class="mod-actions-menu print-hidden"></div>
<div id="mod-actions-menu-btn-area" class="print-hidden"></div>
<div data-testid="flag-user-modal-container" class="flag-user-modal-container hidden"></div>

<div class="fullscreen-code js-fullscreen-code"></div>
<%= javascript_packs_with_chunks_tag "followButtons", defer: true %>

<% cache("article-show-scripts", expires_in: 8.hours) do %>
  <script>
    <%# we consider these scripts safe for embedding as they come from our code %>
    <%== PodcastTag.script %>
    <%== PollTag.script %>
    <%== RunkitTag.script %>
    <%== TweetTag.script %>
    <%== UserSubscriptionTag.script %>
  </script>
<% end %>
